generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                     String             @id @default(cuid())
  email                  String             @unique
  passwordHash           String
  name                   String
  role                   Role               @default(ADMIN)
  bio                    String?
  phone                  String?
  location               String?
  website                String?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt
  lockedUntil            DateTime?
  failedLoginCount       Int                @default(0)
  lastLoginAt            DateTime?
  lastLoginIp            String?
  sessionExpiry          DateTime?
  activities             Activity[]
  businessPlansGenerated BusinessPlan[]
  deliverablesGenerated  Deliverable[]
  filesUploaded          File[]
  helpArticles           HelpArticle[]
  loginAttempts          LoginAttempt[]
  notes                  Note[]
  ticketAttachments      TicketAttachment[]
  ticketComments         TicketComment[]
  assignedTickets        Ticket[]           @relation("AssignedTickets")

  @@map("users")
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ip        String
  userAgent String?
  success   Boolean
  reason    String?
  createdAt DateTime @default(now())
  userId    String?
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email, createdAt])
  @@index([ip, createdAt])
  @@index([userId, createdAt])
  @@map("login_attempts")
}

model Client {
  id                      String                   @id @default(cuid())
  fullName                String
  email                   String                   @unique
  instagramHandle         String?
  tiktokHandle            String?
  country                 String
  industryNiche           String
  age                     Int
  professionalMilestones  String
  personalTurningPoints   String
  visionForVenture        String
  hopeToAchieve           String
  targetAudience          String
  demographicProfile      String
  targetDemographicAge    String
  audienceGenderSplit     String
  audienceMaritalStatus   String
  currentChannels         String
  keyPainPoints           String
  brandValues             String
  differentiation         String
  uniqueValueProps        String
  emergingCompetitors     String
  idealBrandImage         String
  inspirationBrands       String
  brandingAesthetics      String
  emotionsBrandEvokes     String
  brandPersonality        String
  preferredFont           String
  productCategories       String[]
  otherProductIdeas       String?
  scalingGoals            String
  growthStrategies        String
  longTermVision          String
  specificDeadlines       String?
  additionalInfo          String?
  status                  ClientStatus             @default(ACTIVE)
  onboardedAt             DateTime                 @default(now())
  createdAt               DateTime                 @default(now())
  updatedAt               DateTime                 @updatedAt
  deletedAt               DateTime?
  activities              Activity[]
  applications            Application[]
  businessPlans           BusinessPlan[]
  portalUser              ClientPortalUser?
  deliverables            Deliverable[]
  files                   File[]
  notes                   Note[]
  notificationPreferences NotificationPreferences?
  portalMessages          PortalMessage[]
  tickets                 Ticket[]

  @@map("clients")
}

model BusinessPlan {
  id              String         @id @default(cuid())
  clientId        String
  version         Int            @default(1)
  status          DocumentStatus @default(DRAFT)
  contentMarkdown String
  pdfPath         String?
  generatedBy     String
  generatedAt     DateTime       @default(now())
  approvedAt      DateTime?
  deliveredAt     DateTime?
  rejectionReason String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  client          Client         @relation(fields: [clientId], references: [id], onDelete: Cascade)
  generatedByUser User           @relation(fields: [generatedBy], references: [id])

  @@map("business_plans")
}

model Deliverable {
  id              String          @id @default(cuid())
  clientId        String
  month           Int
  title           String
  type            DeliverableType @default(MAIN)
  parentId        String?
  contentMarkdown String
  pdfPath         String?
  status          DocumentStatus  @default(DRAFT)
  generatedBy     String
  generatedAt     DateTime        @default(now())
  approvedAt      DateTime?
  deliveredAt     DateTime?
  rejectionReason String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  client          Client          @relation(fields: [clientId], references: [id], onDelete: Cascade)
  generatedByUser User            @relation(fields: [generatedBy], references: [id])
  parent          Deliverable?    @relation("subdocuments", fields: [parentId], references: [id])
  subdocuments    Deliverable[]   @relation("subdocuments")

  @@map("deliverables")
}

model File {
  id             String       @id @default(cuid())
  clientId       String?
  filename       String
  filepath       String
  filesize       Int
  mimetype       String
  category       FileCategory @default(UPLOAD)
  uploadedBy     String
  uploadedAt     DateTime     @default(now())
  deletedAt      DateTime?
  client         Client?      @relation(fields: [clientId], references: [id])
  uploadedByUser User         @relation(fields: [uploadedBy], references: [id])

  @@map("files")
}

model PromptTemplate {
  id          String             @id @default(cuid())
  name        String
  description String?
  type        PromptTemplateType
  content     String
  variables   String?
  yamlPath    String?
  isActive    Boolean            @default(false)
  isDefault   Boolean            @default(false)
  version     Int                @default(1)
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  @@map("prompt_templates")
}

model Job {
  id          String    @id @default(cuid())
  type        JobType
  status      JobStatus @default(QUEUED)
  payload     String
  result      String?
  error       String?
  attempts    Int       @default(0)
  createdAt   DateTime  @default(now())
  startedAt   DateTime?
  completedAt DateTime?

  @@map("jobs")
}

model Note {
  id          String   @id @default(cuid())
  clientId    String
  content     String
  isImportant Boolean  @default(false)
  tags        String?
  category    String?
  authorId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  author      User     @relation(fields: [authorId], references: [id])
  client      Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("notes")
}

model Activity {
  id          String       @id @default(cuid())
  clientId    String?
  type        ActivityType
  description String
  metadata    String?
  userId      String?
  createdAt   DateTime     @default(now())
  client      Client?      @relation(fields: [clientId], references: [id])
  user        User?        @relation(fields: [userId], references: [id])

  @@map("activities")
}

model BackupLog {
  id        String       @id @default(cuid())
  filename  String
  filepath  String
  filesize  Int
  status    BackupStatus
  verified  Boolean      @default(false)
  error     String?
  createdAt DateTime     @default(now())

  @@map("backup_logs")
}

model Settings {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt

  @@map("settings")
}

model Application {
  id                     String    @id @default(cuid())
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  fullName               String
  email                  String
  instagramHandle        String?
  tiktokHandle           String?
  country                String
  industryNiche          String
  age                    Int
  professionalMilestones String
  personalTurningPoints  String
  visionForVenture       String
  hopeToAchieve          String
  targetAudience         String
  demographicProfile     String
  targetDemographicAge   String
  audienceGenderSplit    String
  audienceMaritalStatus  String?
  currentChannels        String
  keyPainPoints          String
  brandValues            String
  differentiation        String
  uniqueValueProps       String
  emergingCompetitors    String?
  idealBrandImage        String
  inspirationBrands      String?
  brandingAesthetics     String
  emotionsBrandEvokes    String?
  brandPersonality       String
  preferredFont          String?
  productCategories      String
  otherProductIdeas      String?
  scalingGoals           String
  growthStrategies       String?
  longTermVision         String
  specificDeadlines      String?
  additionalInfo         String?
  zipFilePath            String?
  zipFileName            String?
  zipFileSize            Int?
  termsAccepted          Boolean   @default(false)
  status                 String    @default("PENDING")
  reviewedAt             DateTime?
  reviewNotes            String?
  convertedToClientId    String?
  convertedToClient      Client?   @relation(fields: [convertedToClientId], references: [id])

  @@index([email])
  @@index([createdAt])
  @@index([status])
  @@map("applications")
}

model TokenUsage {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  operation        String
  model            String
  promptTokens     Int
  completionTokens Int
  totalTokens      Int
  estimatedCost    Float
  clientId         String?
  userId           String?
  jobId            String?
  documentId       String?
  documentType     String?
  cacheHit         Boolean  @default(false)
  cacheKey         String?
  requestDuration  Int?
  success          Boolean  @default(true)
  errorMessage     String?

  @@index([createdAt])
  @@index([operation])
  @@index([clientId])
  @@index([cacheKey])
  @@map("token_usage")
}

model PromptCache {
  id          String   @id @default(cuid())
  createdAt   DateTime @default(now())
  expiresAt   DateTime
  cacheKey    String   @unique
  promptHash  String
  response    String
  model       String
  hitCount    Int      @default(0)
  lastUsedAt  DateTime @default(now())
  tokensSaved Int      @default(0)

  @@index([cacheKey])
  @@index([expiresAt])
  @@map("prompt_cache")
}

model GenerationCheckpoint {
  id                String   @id @default(cuid())
  createdAt         DateTime @default(now())
  jobId             String   @unique
  jobType           String
  status            String
  totalSections     Int
  completedSections Int
  currentSection    Int
  documentId        String?
  clientId          String
  generatedContent  String
  promptContext     String
  canResume         Boolean  @default(true)
  lastCheckpoint    DateTime @default(now())
  errorMessage      String?

  @@index([jobId])
  @@index([clientId])
  @@index([status])
  @@map("generation_checkpoints")
}

model DocumentSection {
  id           String    @id @default(cuid())
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  documentId   String
  documentType String
  sectionName  String
  sectionOrder Int
  content      String
  generatedBy  String?
  generatedAt  DateTime?
  tokensUsed   Int?
  version      Int       @default(1)

  @@index([documentId, documentType])
  @@index([sectionName])
  @@map("document_sections")
}

model TokenBudget {
  id               String   @id @default(cuid())
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  period           String
  startDate        DateTime
  endDate          DateTime
  tokenLimit       Int
  costLimit        Float
  tokensUsed       Int      @default(0)
  costUsed         Float    @default(0)
  alertAt50        Boolean  @default(true)
  alertAt75        Boolean  @default(true)
  alertAt90        Boolean  @default(true)
  alertAt100       Boolean  @default(true)
  alert50Sent      Boolean  @default(false)
  alert75Sent      Boolean  @default(false)
  alert90Sent      Boolean  @default(false)
  alert100Sent     Boolean  @default(false)
  autoPauseAtLimit Boolean  @default(false)
  isPaused         Boolean  @default(false)
  isActive         Boolean  @default(true)

  @@index([period])
  @@index([endDate])
  @@map("token_budgets")
}

model ClientPortalUser {
  id                      String               @id @default(cuid())
  clientId                String               @unique
  email                   String               @unique
  passwordHash            String
  isActive                Boolean              @default(false)
  invitedAt               DateTime             @default(now())
  activatedAt             DateTime?
  lastLoginAt             DateTime?
  passwordChangedAt       DateTime?
  emailVerified           Boolean              @default(false)
  createdAt               DateTime             @default(now())
  updatedAt               DateTime             @updatedAt
  inviteToken             String?              @unique
  inviteTokenExpiry       DateTime?
  invitedBy               String?
  completedOnboarding     Boolean              @default(false)
  onboardingCompletedAt   DateTime?
  notifyNewDeliverable    Boolean              @default(true)
  notifyNewMessage        Boolean              @default(true)
  notifyMilestoneReminder Boolean              @default(true)
  notifyWeeklySummary     Boolean              @default(false)
  client                  Client               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  messages                PortalMessage[]
  notifications           PortalNotification[]

  @@index([email])
  @@index([clientId])
  @@map("client_portal_users")
}

model PortalMessage {
  id             String            @id @default(cuid())
  threadId       String
  clientUserId   String?
  adminUserId    String?
  clientId       String
  subject        String
  body           String
  isFromAdmin    Boolean
  isRead         Boolean           @default(false)
  attachmentUrl  String?
  attachmentName String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  client         Client            @relation(fields: [clientId], references: [id], onDelete: Cascade)
  clientUser     ClientPortalUser? @relation(fields: [clientUserId], references: [id])

  @@index([threadId])
  @@index([clientId])
  @@index([createdAt])
  @@map("portal_messages")
}

model PortalNotification {
  id           String           @id @default(cuid())
  clientUserId String
  type         String
  title        String
  message      String
  actionUrl    String?
  isRead       Boolean          @default(false)
  createdAt    DateTime         @default(now())
  clientUser   ClientPortalUser @relation(fields: [clientUserId], references: [id], onDelete: Cascade)

  @@index([clientUserId])
  @@index([isRead])
  @@index([createdAt])
  @@map("portal_notifications")
}

model NotificationPreferences {
  id                      String   @id @default(cuid())
  clientId                String   @unique
  emailWelcome            Boolean  @default(true)
  emailActivation         Boolean  @default(true)
  emailBusinessPlanReady  Boolean  @default(true)
  emailDeliverableReady   Boolean  @default(true)
  emailDeliverableOverdue Boolean  @default(true)
  emailMilestoneReached   Boolean  @default(true)
  emailJourneyCompleted   Boolean  @default(true)
  emailWeeklyDigest       Boolean  @default(false)
  emailMarketingUpdates   Boolean  @default(false)
  portalNewDeliverable    Boolean  @default(true)
  portalNewMessage        Boolean  @default(true)
  portalMilestoneReminder Boolean  @default(true)
  portalAccountUpdate     Boolean  @default(true)
  preferredContactMethod  String   @default("email")
  reminderFrequency       String   @default("daily")
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  client                  Client   @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@map("notification_preferences")
}

model Ticket {
  id           String             @id @default(cuid())
  clientId     String
  assignedTo   String?
  title        String
  description  String
  status       TicketStatus       @default(OPEN)
  priority     TicketPriority     @default(MEDIUM)
  category     String?
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  closedAt     DateTime?
  resolvedAt   DateTime?
  attachments  TicketAttachment[]
  comments     TicketComment[]
  assignedUser User?              @relation("AssignedTickets", fields: [assignedTo], references: [id])
  client       Client             @relation(fields: [clientId], references: [id], onDelete: Cascade)

  @@index([clientId])
  @@index([assignedTo])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@map("tickets")
}

model TicketComment {
  id         String   @id @default(cuid())
  ticketId   String
  authorId   String
  content    String
  isInternal Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  author     User     @relation(fields: [authorId], references: [id])
  ticket     Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  @@index([ticketId])
  @@index([authorId])
  @@index([createdAt])
  @@map("ticket_comments")
}

model TicketAttachment {
  id             String   @id @default(cuid())
  ticketId       String
  uploadedBy     String
  filename       String
  filepath       String
  filesize       Int
  mimetype       String
  createdAt      DateTime @default(now())
  ticket         Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  uploadedByUser User     @relation(fields: [uploadedBy], references: [id])

  @@index([ticketId])
  @@map("ticket_attachments")
}

model HelpCategory {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  icon        String?
  order       Int           @default(0)
  isPublished Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  articles    HelpArticle[]

  @@index([slug])
  @@index([order])
  @@map("help_categories")
}

model HelpArticle {
  id          String       @id @default(cuid())
  categoryId  String
  title       String
  slug        String       @unique
  content     String
  excerpt     String?
  tags        String?
  viewCount   Int          @default(0)
  isPublished Boolean      @default(true)
  isFeatured  Boolean      @default(false)
  authorId    String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  publishedAt DateTime?
  author      User         @relation(fields: [authorId], references: [id])
  category    HelpCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([slug])
  @@index([isPublished])
  @@index([isFeatured])
  @@index([viewCount])
  @@map("help_articles")
}

enum Role {
  ADMIN
  CLIENT
}

enum ClientStatus {
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum DocumentStatus {
  DRAFT
  PENDING_REVIEW
  APPROVED
  DELIVERED
  REJECTED
}

enum DeliverableType {
  MAIN
  SUBDOCUMENT
}

enum FileCategory {
  BUSINESS_PLAN
  DELIVERABLE
  UPLOAD
  MISC
}

enum PromptTemplateType {
  BUSINESS_PLAN
  DELIVERABLE_M1
  DELIVERABLE_M2
  DELIVERABLE_M3
  DELIVERABLE_M4
  DELIVERABLE_M5
  DELIVERABLE_M6
  DELIVERABLE_M7
  DELIVERABLE_M8
  CUSTOM
}

enum JobType {
  GENERATE_BUSINESS_PLAN
  GENERATE_DELIVERABLE
  GENERATE_PDF
  SUMMARIZE_THREAD
  BACKUP_DATABASE
  CLEANUP_FILES
  CLEANUP_OLD_JOBS
  SEND_EMAIL
  SEND_REMINDER_EMAILS
  UPDATE_CLIENT_METRICS
}

enum JobStatus {
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}

enum ActivityType {
  CLIENT_CREATED
  CLIENT_UPDATED
  CLIENT_DELETED
  CLIENT_ARCHIVED
  CLIENT_RESTORED
  BUSINESS_PLAN_GENERATED
  BUSINESS_PLAN_UPDATED
  BUSINESS_PLAN_APPROVED
  BUSINESS_PLAN_DELIVERED
  BUSINESS_PLAN_REJECTED
  DELIVERABLE_GENERATED
  DELIVERABLE_UPDATED
  DELIVERABLE_APPROVED
  DELIVERABLE_DELIVERED
  DELIVERABLE_REJECTED
  FILE_UPLOADED
  APPLICATION_SUBMITTED
  FILE_DELETED
  NOTE_CREATED
  NOTE_UPDATED
  NOTE_DELETED
  PROMPT_CREATED
  PROMPT_UPDATED
  PROMPT_DELETED
  BACKUP_CREATED
  BACKUP_RESTORED
  SETTINGS_UPDATED
}

enum BackupStatus {
  SUCCESS
  FAILED
}

enum TicketStatus {
  OPEN
  IN_PROGRESS
  WAITING_ON_CLIENT
  WAITING_ON_TEAM
  RESOLVED
  CLOSED
}

enum TicketPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}
